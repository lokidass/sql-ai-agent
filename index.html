<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL AI Agent | Multi-DB Intelligence</title>
    <link rel="stylesheet" href="index.css">
    <!-- Include Mermaid.js -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Include SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.4/xlsx.full.min.js"></script>
</head>

<body>
    <div id="sidebar">
        <h3><span class="icon">ðŸ“¦</span> Databases</h3>
        <div id="databasesList" class="db-list">
            <!-- Dynamically populated -->
        </div>
        <button id="btnConnect" class="secondary" style="margin-top: 20px; width: 100%;">
            <span>ðŸ”Œ</span> Connect New DB
        </button>
    </div>

    <div id="main">
        <header>
            <h1>AI SQL Agent</h1>
            <div id="conStatus" class="connection-status">Not Connected</div>
        </header>

        <section class="query-container">
            <div class="input-group">
                <input type="text" id="queryInput"
                    placeholder="Ask anything about your data... (e.g., 'Show top 5 users by age')">
                <button id="btnGenerate" onclick="generateQuery()">
                    <span class="btn-text">âœ¨ Generate</span>
                    <span class="loader" style="display: none;"></span>
                </button>
            </div>
            <div id="queryOutputContainer" style="display: none;">
                <div class="code-block" id="sqlOutput"></div>
                <div style="display: flex; gap: 10px;">
                    <button id="btnExecute" onclick="executeSQL()">ðŸš€ Confirm & Execute</button>
                    <button class="secondary" onclick="clearQuery()">Clear</button>
                </div>
            </div>
        </section>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('results')">Results</div>
            <div class="tab" onclick="switchTab('visualization')">Visualization</div>
            <div class="tab" onclick="switchTab('structure')">Structure</div>
            <div class="tab" onclick="switchTab('erd')">ER Diagram</div>
        </div>

        <div id="resultsTab" class="tab-content">
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-bottom: 15px;">
                <button class="secondary" onclick="exportData('csv')">CSV</button>
                <button class="secondary" onclick="exportData('excel')">Excel</button>
                <button class="secondary" onclick="exportData('json')">JSON</button>
            </div>
            <div class="table-container" id="resultOutput">
                <p style="padding: 20px; color: var(--text-muted);">Run a query to see results...</p>
            </div>
        </div>

        <div id="visualizationTab" class="tab-content" style="display: none;">
            <div class="query-container" style="display: flex; gap: 15px; align-items: flex-end;">
                <div class="form-group">
                    <label>Chart Type</label>
                    <select id="chartType">
                        <option value="bar">Bar Chart</option>
                        <option value="line">Line Chart</option>
                        <option value="pie">Pie Chart</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>X Axis</label>
                    <select id="xAxis"></select>
                </div>
                <div class="form-group">
                    <label>Y Axis</label>
                    <select id="yAxis"></select>
                </div>
                <button class="secondary" onclick="renderChart()">Update Chart</button>
            </div>
            <div class="chart-container">
                <canvas id="dataChart"></canvas>
            </div>
        </div>

        <div id="structureTab" class="tab-content" style="display: none;">
            <div class="table-container" id="tableStructureOutput">
                <p style="padding: 20px; color: var(--text-muted);">Select a table from the sidebar...</p>
            </div>
        </div>

        <div id="erdTab" class="tab-content" style="display: none;">
            <div class="query-container erd-wrapper">
                <div id="erdOutput" class="mermaid-container">
                    <p style="color: var(--text-muted);">Select a database to generate ERD...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Connection Modal -->
    <div id="connectModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <h2>Connect Database</h2>
            <div class="form-group">
                <label>Database Type</label>
                <select id="dbType">
                    <option value="mysql">MySQL</option>
                    <option value="postgres">PostgreSQL</option>
                    <option value="mongodb">MongoDB</option>
                </select>
            </div>
            <div id="standardFields">
                <div class="form-group">
                    <label>Host</label>
                    <input type="text" id="dbHost" value="localhost">
                </div>
                <div class="form-group">
                    <label>Port</label>
                    <input type="text" id="dbPort" placeholder="Default">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="dbUser" value="root">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="dbPass"
                        style="width: 100%; padding: 12px; border-radius: 10px; background: var(--bg-dark); border: 1px solid var(--border); color: white;">
                </div>
            </div>
            <div id="mongoFields" style="display: none;">
                <div class="form-group">
                    <label>Connection URI (Optional)</label>
                    <input type="text" id="dbUri" placeholder="mongodb://localhost:27017">
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button style="flex: 1" onclick="connectDB()">Connect</button>
                <button class="secondary" onclick="closeModal()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="chatbot">
        <div id="chatbotHeader">
            <span>AI Assistant</span>
            <button class="secondary" onclick="toggleChat()" style="padding: 4px 8px;">_</button>
        </div>
        <div id="chatbotBody">
            <div class="message bot">Hello! I can help you understand your data or refine queries. What's on your mind?
            </div>
        </div>
        <div id="chatbotInput">
            <input type="text" id="chatMsg" placeholder="Type a message...">
            <button onclick="sendChat()">Send</button>
        </div>
    </div>

    <script>
        let currentConfig = null;
        let selectedDb = null;
        let selectedTable = null;
        let queryResults = null;
        let myChart = null;

        const API_BASE = "http://localhost:3002";

        // Navigation
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const target = document.getElementById(tabId + 'Tab');
            if (target) target.style.display = 'block';
            event.currentTarget.classList.add('active');
        }

        function toggleLoading(btnId, isLoading) {
            const btn = document.getElementById(btnId);
            if (!btn) return;
            const text = btn.querySelector('.btn-text');
            const loader = btn.querySelector('.loader');
            if (isLoading) {
                if (text) text.style.display = 'none';
                if (loader) loader.style.display = 'inline-block';
                btn.disabled = true;
            } else {
                if (text) text.style.display = 'inline-block';
                if (loader) loader.style.display = 'none';
                btn.disabled = false;
            }
        }

        // Modal Logic
        document.getElementById('btnConnect').onclick = () => document.getElementById('connectModal').style.display = 'flex';
        function closeModal() { document.getElementById('connectModal').style.display = 'none'; }

        document.getElementById('dbType').onchange = (e) => {
            const isMongo = e.target.value === 'mongodb';
            document.getElementById('standardFields').style.display = isMongo ? 'none' : 'block';
            document.getElementById('mongoFields').style.display = isMongo ? 'block' : 'none';
        }

        async function connectDB() {
            const type = document.getElementById('dbType').value;
            const config = {
                type,
                host: document.getElementById('dbHost').value,
                port: document.getElementById('dbPort').value,
                user: document.getElementById('dbUser').value,
                password: document.getElementById('dbPass').value,
                uri: document.getElementById('dbUri').value
            };

            const res = await fetch(`${API_BASE}/connect`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            const data = await res.json();

            if (data.success) {
                currentConfig = config;
                document.getElementById('conStatus').innerText = `Connected to ${type}`;
                document.getElementById('conStatus').style.color = 'var(--success)';
                closeModal();
                fetchDatabases();
            } else {
                alert("Connection failed: " + data.error);
            }
        }

        async function fetchDatabases() {
            const res = await fetch(`${API_BASE}/databases`);
            const data = await res.json();
            if (data.success) {
                const list = document.getElementById('databasesList');
                list.innerHTML = data.databases.map(db => `
                    <div class="database-item" onclick="selectDb('${db}')">${db}</div>
                `).join('');
            }
        }

        async function selectDb(db) {
            selectedDb = db;
            document.querySelectorAll('.database-item').forEach(el => {
                if (el.innerText === db) el.classList.add('active');
                else el.classList.remove('active');
            });
            fetchTables(db);
            fetchERD(db);
        }

        async function fetchTables(db) {
            const res = await fetch(`${API_BASE}/tables/${db}`);
            const data = await res.json();
            if (data.success) {
                const activeDbEl = document.querySelector('.database-item.active');
                const existingTables = activeDbEl.querySelectorAll('.table-item');
                existingTables.forEach(t => t.remove());

                data.tables.forEach(table => {
                    const tEl = document.createElement('div');
                    tEl.className = 'table-item';
                    tEl.innerText = table;
                    tEl.onclick = (e) => {
                        e.stopPropagation();
                        fetchTableStructure(table);
                    };
                    activeDbEl.appendChild(tEl);
                });
            }
        }

        async function fetchTableStructure(table) {
            selectedTable = table;
            const res = await fetch(`${API_BASE}/table/${selectedDb}/${table}`);
            const data = await res.json();
            if (data.success) {
                renderTable(data.structure, 'tableStructureOutput');
                switchTab('structure');
            }
        }

        async function generateQuery() {
            const question = document.getElementById('queryInput').value;
            if (!question) return;

            toggleLoading('btnGenerate', true);
            try {
                const res = await fetch(`${API_BASE}/query`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        question,
                        context: {
                            dbType: currentConfig ? currentConfig.type : 'mysql',
                            database: selectedDb,
                            table: selectedTable
                        }
                    })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('queryOutputContainer').style.display = 'block';
                    document.getElementById('sqlOutput').innerText = data.query;
                } else {
                    alert("Query error: " + data.error);
                }
            } catch (e) {
                alert("AI Connection Failed. Make sure server is running on 3001.");
            } finally {
                toggleLoading('btnGenerate', false);
            }
        }

        async function executeSQL() {
            const query = document.getElementById('sqlOutput').innerText;
            toggleLoading('btnExecute', true);
            try {
                const res = await fetch(`${API_BASE}/execute`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query, database: selectedDb })
                });
                const data = await res.json();
                if (data.success) {
                    queryResults = data.result;
                    renderTable(data.result, 'resultOutput');
                    updateChartSelectors();
                    switchTab('results');
                } else {
                    alert("Execution Error: " + data.error);
                }
            } catch (e) {
                alert("Execution Failed.");
            } finally {
                toggleLoading('btnExecute', false);
            }
        }

        function renderTable(data, targetId) {
            const container = document.getElementById(targetId);
            if (!data || data.length === 0) {
                container.innerHTML = '<p style="padding: 20px;">No data available.</p>';
                return;
            }
            const headers = Object.keys(data[0]);
            container.innerHTML = `
                <table>
                    <thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                    <tbody>
                        ${data.map(row => `<tr>${headers.map(h => `<td>${row[h]}</td>`).join('')}</tr>`).join('')}
                    </tbody>
                </table>
            `;
        }

        function updateChartSelectors() {
            if (!queryResults || queryResults.length === 0) return;
            const cols = Object.keys(queryResults[0]);
            const x = document.getElementById('xAxis');
            const y = document.getElementById('yAxis');
            x.innerHTML = cols.map(c => `<option value="${c}">${c}</option>`).join('');
            y.innerHTML = cols.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function renderChart() {
            const ctx = document.getElementById('dataChart').getContext('2d');
            const type = document.getElementById('chartType').value;
            const xAttr = document.getElementById('xAxis').value;
            const yAttr = document.getElementById('yAxis').value;

            if (myChart) myChart.destroy();

            myChart = new Chart(ctx, {
                type,
                data: {
                    labels: queryResults.map(r => r[xAttr]),
                    datasets: [{
                        label: yAttr,
                        data: queryResults.map(r => r[yAttr]),
                        backgroundColor: 'rgba(99, 102, 241, 0.5)',
                        borderColor: '#6366f1',
                        borderWidth: 2
                    }]
                }
            });
            switchTab('visualization');
        }

        async function fetchERD(db) {
            const res = await fetch(`${API_BASE}/erd/${db}`);
            const data = await res.json();
            if (data.success && data.erd) {
                const out = document.getElementById('erdOutput');
                out.innerHTML = `<div class="mermaid">${data.erd}</div>`;
                mermaid.init();
            }
        }

        async function sendChat() {
            const msg = document.getElementById('chatMsg').value;
            if (!msg) return;
            const body = document.getElementById('chatbotBody');
            body.innerHTML += `<div class="message user">${msg}</div>`;
            document.getElementById('chatMsg').value = '';

            const res = await fetch(`${API_BASE}/chatbot`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: msg,
                    context: { database: selectedDb, table: selectedTable }
                })
            });
            const data = await res.json();
            body.innerHTML += `<div class="message bot">${data.response}</div>`;
            body.scrollTop = body.scrollHeight;
        }

        window.onload = () => {
            mermaid.initialize({ startOnLoad: false, theme: 'dark' });
        };
    </script>
</body>

</html>